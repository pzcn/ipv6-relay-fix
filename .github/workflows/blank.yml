name: Build IPv6 Relay Fix IPK (ARM Cortex-A53)

on:
  push:
    branches: [ main ]
    paths:
      - 'package/network/ipv6/ipv6-relay-fix/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'package/network/ipv6/ipv6-relay-fix/**'
  workflow_dispatch:

env:
  OPENWRT_VERSION: master
  TARGET_ARCH: aarch64_cortex-a53

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Initialize environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git \
          libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget subversion
        
    - name: Cache OpenWrt source
      id: cache-openwrt
      uses: actions/cache@v3
      with:
        path: openwrt
        key: openwrt-master-aarch64-cortex-a53-${{ hashFiles('package/network/ipv6/ipv6-relay-fix/**') }}
        
    - name: Download OpenWrt source
      if: steps.cache-openwrt.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
        
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Copy package to OpenWrt
      run: |
        mkdir -p openwrt/package/network/ipv6/
        cp -r package/network/ipv6/ipv6-relay-fix openwrt/package/network/ipv6/
        
    - name: Generate build config for ARM Cortex-A53
      run: |
        cd openwrt
        cat > .config << EOF
        # Target for ARM Cortex-A53 (aarch64)
        CONFIG_TARGET_sunxi=y
        CONFIG_TARGET_sunxi_cortexa53=y
        CONFIG_TARGET_sunxi_cortexa53_DEVICE_sun50i-a64-pine64-plus=y
        
        # IPv6 essential packages
        CONFIG_PACKAGE_odhcpd=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y
        CONFIG_PACKAGE_kmod-ipv6=y
        CONFIG_PACKAGE_ip6tables=y
        
        # Our IPv6 relay fix package
        CONFIG_PACKAGE_ipv6-relay-fix=m
        
        # IPv6 kernel support
        CONFIG_IPV6=y
        CONFIG_KERNEL_IPV6=y
        
        # Basic networking
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_firewall4=y
        CONFIG_PACKAGE_nftables=y
        
        # Build system
        CONFIG_DEVEL=y
        CONFIG_CCACHE=y
        EOF
        
        make defconfig
        
    - name: Download dependencies
      run: |
        cd openwrt
        make download -j$(nproc) || make download -j1 V=s
        
    - name: Build toolchain
      run: |
        cd openwrt
        make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
        
    - name: Build package
      run: |
        cd openwrt
        make package/ipv6-relay-fix/compile -j$(nproc) V=s
        
    - name: Find and prepare package
      id: package
      run: |
        cd openwrt
        
        # Find the built package
        PACKAGE_FILE=$(find bin -name "ipv6-relay-fix*.ipk" -type f | head -1)
        
        if [ -z "$PACKAGE_FILE" ]; then
          echo "âŒ Package not found!"
          find bin -name "*.ipk" | head -10
          exit 1
        fi
        
        PACKAGE_NAME=$(basename "$PACKAGE_FILE")
        PACKAGE_DIR=$(dirname "$PACKAGE_FILE")
        
        echo "package_file=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "package_path=$PACKAGE_FILE" >> $GITHUB_OUTPUT
        echo "package_dir=$PACKAGE_DIR" >> $GITHUB_OUTPUT
        
        # Create package info
        cat > package_info.txt << EOF
        ðŸ“¦ IPv6 Relay Fix Package for ARM Cortex-A53
        
        Package: $PACKAGE_NAME
        Architecture: aarch64_cortex-a53
        OpenWrt Version: master ($(git -C . rev-parse --short HEAD))
        Built: $(date)
        
        ðŸš€ Installation:
        scp $PACKAGE_NAME root@192.168.1.1:/tmp/
        ssh root@192.168.1.1 "opkg install /tmp/$PACKAGE_NAME"
        
        âš™ï¸ Configuration:
        uci set ipv6-relay-fix.global.enabled='1'
        uci commit ipv6-relay-fix
        /etc/init.d/ipv6-relay-fix restart
        
        ðŸ“‹ Compatible devices:
        - Pine64 Plus A64
        - Orange Pi series (A64/H5)
        - Banana Pi M64
        - NanoPi A64
        - Other ARM Cortex-A53 based devices
        EOF
        
        echo "âœ… Package built successfully: $PACKAGE_NAME"
        
    - name: Upload package artifact
      uses: actions/upload-artifact@v3
      with:
        name: ipv6-relay-fix-aarch64-cortex-a53
        path: |
          openwrt/${{ steps.package.outputs.package_path }}
          openwrt/package_info.txt
        retention-days: 30
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          openwrt/${{ steps.package.outputs.package_path }}
          openwrt/package_info.txt
        name: IPv6 Relay Fix ${{ github.ref_name }} (ARM Cortex-A53)
        body: |
          ## IPv6 Relay Fix Package - ARM Cortex-A53
          
          **Architecture:** aarch64_cortex-a53  
          **OpenWrt Version:** master  
          **Package:** `${{ steps.package.outputs.package_file }}`
          
          ### ðŸŽ¯ Compatible Devices
          - Pine64 Plus A64, Orange Pi series (A64/H5)
          - Banana Pi M64, NanoPi A64
          - Other ARM Cortex-A53 based SBCs
          
          ### ðŸ“¥ Quick Install
          ```
          # Upload to device
          scp ${{ steps.package.outputs.package_file }} root@192.168.1.1:/tmp/
          
          # Install and configure
          ssh root@192.168.1.1
          opkg install /tmp/${{ steps.package.outputs.package_file }}
          uci set ipv6-relay-fix.global.enabled='1'
          uci commit ipv6-relay-fix
          /etc/init.d/ipv6-relay-fix restart
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
