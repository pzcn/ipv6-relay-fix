name: Build IPv6 Relay Fix IPK (ARM Cortex-A53)

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Makefile'
      - 'files/**'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'Makefile'
      - 'files/**'
  workflow_dispatch:

env:
  OPENWRT_VERSION: master
  TARGET_ARCH: aarch64_cortex-a53

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Verify package structure in root
      run: |
        echo "ðŸ“ Checking repository structure..."
        echo "ðŸ“‹ Current directory contents:"
        ls -la
        
        # Check required files in root
        if [ ! -f "Makefile" ]; then
          echo "âŒ Error: Makefile not found in root!"
          exit 1
        fi
        
        if [ ! -d "files" ]; then
          echo "âŒ Error: files directory not found in root!"
          exit 1
        fi
        
        echo "âœ… Root package structure exists"
        echo "ðŸ“‹ Files directory contents:"
        ls -la files/
        
        # Check required files
        for file in files/99-ipv6-relay-config files/99-ipv6-route-fix; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done
        echo "âœ… All required files present"
      
    - name: Initialize environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git \
          libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget subversion
        
    - name: Cache OpenWrt source
      id: cache-openwrt
      uses: actions/cache@v4
      with:
        path: openwrt
        key: openwrt-master-aarch64-cortex-a53-${{ hashFiles('Makefile', 'files/**') }}
        
    - name: Download OpenWrt source
      if: steps.cache-openwrt.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
        
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Create package structure and copy files from root
      run: |
        echo "ðŸ“ Creating OpenWrt package structure..."
        mkdir -p openwrt/package/network/ipv6/ipv6-relay-fix
        
        echo "ðŸ“‹ Copying Makefile from root..."
        cp Makefile openwrt/package/network/ipv6/ipv6-relay-fix/
        
        echo "ðŸ“‹ Copying files directory from root..."
        cp -r files openwrt/package/network/ipv6/ipv6-relay-fix/
        
        echo "ðŸ“‹ Verification - OpenWrt package structure:"
        ls -la openwrt/package/network/ipv6/ipv6-relay-fix/
        echo "ðŸ“‹ Files directory in OpenWrt:"
        ls -la openwrt/package/network/ipv6/ipv6-relay-fix/files/
        
        echo "âœ… Package structure created and files copied"
        
    - name: Generate build config for ARM Cortex-A53
      working-directory: openwrt  # ä½¿ç”¨working-directoryå…³é”®å­—
      run: |
        cat > .config << EOF
        # Target for ARM Cortex-A53 (aarch64)
        CONFIG_TARGET_sunxi=y
        CONFIG_TARGET_sunxi_cortexa53=y
        CONFIG_TARGET_sunxi_cortexa53_DEVICE_sun50i-a64-pine64-plus=y
        
        # IPv6 essential packages
        CONFIG_PACKAGE_odhcpd=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y
        CONFIG_PACKAGE_kmod-ipv6=y
        CONFIG_PACKAGE_ip6tables=y
        
        # Our IPv6 relay fix package
        CONFIG_PACKAGE_ipv6-relay-fix=m
        
        # IPv6 kernel support
        CONFIG_IPV6=y
        CONFIG_KERNEL_IPV6=y
        
        # Basic networking
        CONFIG_PACKAGE_dnsmasq=y
        CONFIG_PACKAGE_firewall4=y
        CONFIG_PACKAGE_nftables=y
        
        # Build system
        CONFIG_DEVEL=y
        CONFIG_CCACHE=y
        EOF
        
        make defconfig
        
    - name: Download dependencies
      working-directory: openwrt
      run: |
        make download -j$(nproc) || make download -j1 V=s
        
    - name: Build toolchain
      working-directory: openwrt
      run: |
        make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
        
    - name: Build package
      working-directory: openwrt
      run: |
        make package/ipv6-relay-fix/compile -j$(nproc) V=s
        
    - name: Find and prepare package
      id: package
      working-directory: openwrt
      run: |
        # Find the built package
        PACKAGE_FILE=$(find bin -name "ipv6-relay-fix*.ipk" -type f | head -1)
        
        if [ -z "$PACKAGE_FILE" ]; then
          echo "âŒ Package not found!"
          echo "ðŸ“‹ Available IPK files:"
          find bin -name "*.ipk" | head -10
          exit 1
        fi
        
        PACKAGE_NAME=$(basename "$PACKAGE_FILE")
        
        echo "package_file=$PACKAGE_NAME" >> $GITHUB_OUTPUT
        echo "package_path=$PACKAGE_FILE" >> $GITHUB_OUTPUT
        
        # Create package info
        cat > package_info.txt << EOF
        ðŸ“¦ IPv6 Relay Fix Package for ARM Cortex-A53
        
        Package: $PACKAGE_NAME
        Architecture: aarch64_cortex-a53
        OpenWrt Version: master ($(git -C . rev-parse --short HEAD))
        Built: $(date)
        
        ðŸš€ Installation:
        scp $PACKAGE_NAME root@192.168.1.1:/tmp/
        ssh root@192.168.1.1 "opkg install /tmp/$PACKAGE_NAME"
        
        âš™ï¸ Configuration:
        uci set ipv6-relay-fix.global.enabled='1'
        uci commit ipv6-relay-fix
        /etc/init.d/ipv6-relay-fix restart
        EOF
        
        echo "âœ… Package built successfully: $PACKAGE_NAME"
        
    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: ipv6-relay-fix-aarch64-cortex-a53-${{ github.run_number }}
        path: |
          openwrt/${{ steps.package.outputs.package_path }}
          openwrt/package_info.txt
        retention-days: 30
        compression-level: 6
