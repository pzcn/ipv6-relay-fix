name: Build IPv6 Relay Fix IPK

on:
  push:
    branches: [ main, master ]
    paths:
      - 'package/network/ipv6/ipv6-relay-fix/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'package/network/ipv6/ipv6-relay-fix/**'
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version/branch'
        required: true
        default: 'v23.05.2'
        type: choice
        options:
          - 'v23.05.2'
          - 'v22.03.6'
          - 'master'
      target_arch:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
          - 'aarch64_generic'
          - 'arm_cortex-a9'
          - 'mips_24kc'
          - 'mipsel_24kc'

env:
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'v23.05.2' }}
  TARGET_ARCH: ${{ github.event.inputs.target_arch || 'x86_64' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Initialize environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          subversion \
          qemu-utils
        
    - name: Cache OpenWrt source
      id: cache-openwrt
      uses: actions/cache@v3
      with:
        path: openwrt
        key: openwrt-${{ env.OPENWRT_VERSION }}-${{ hashFiles('.github/workflows/build-ipv6-relay-fix.yml') }}
        
    - name: Download OpenWrt source
      if: steps.cache-openwrt.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        if [[ "${{ env.OPENWRT_VERSION }}" != "master" ]]; then
          git checkout ${{ env.OPENWRT_VERSION }}
        fi
        
    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Copy package to OpenWrt
      run: |
        mkdir -p openwrt/package/network/ipv6/
        cp -r package/network/ipv6/ipv6-relay-fix openwrt/package/network/ipv6/
        
    - name: Generate build config
      run: |
        cd openwrt
        
        # Create minimal config for package compilation
        cat > .config << EOF
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_DEVICE_generic=y
        
        # Essential packages for IPv6
        CONFIG_PACKAGE_odhcpd=y
        CONFIG_PACKAGE_odhcpd-ipv6only=y
        CONFIG_PACKAGE_kmod-ipv6=y
        CONFIG_PACKAGE_ip6tables=y
        
        # Our package
        CONFIG_PACKAGE_ipv6-relay-fix=m
        
        # IPv6 support
        CONFIG_IPV6=y
        CONFIG_KERNEL_IPV6=y
        EOF
        
        # Adjust config for different architectures
        case "${{ env.TARGET_ARCH }}" in
          "aarch64_generic")
            sed -i 's/CONFIG_TARGET_x86=y/CONFIG_TARGET_armvirt=y/' .config
            sed -i 's/CONFIG_TARGET_x86_64=y/CONFIG_TARGET_armvirt_64=y/' .config
            sed -i 's/CONFIG_TARGET_x86_64_DEVICE_generic=y/CONFIG_TARGET_armvirt_64_DEVICE_generic=y/' .config
            ;;
          "arm_cortex-a9")
            sed -i 's/CONFIG_TARGET_x86=y/CONFIG_TARGET_generic=y/' .config
            sed -i 's/CONFIG_TARGET_x86_64=y/CONFIG_TARGET_generic_DEVICE_arm_cortex-a9=y/' .config
            sed -i '/CONFIG_TARGET_x86_64_DEVICE_generic=y/d' .config
            ;;
          "mips_24kc")
            sed -i 's/CONFIG_TARGET_x86=y/CONFIG_TARGET_ath79=y/' .config
            sed -i 's/CONFIG_TARGET_x86_64=y/CONFIG_TARGET_ath79_generic=y/' .config
            sed -i 's/CONFIG_TARGET_x86_64_DEVICE_generic=y/CONFIG_TARGET_ath79_generic_DEVICE_glinet_gl-ar750s-nor=y/' .config
            ;;
        esac
        
        make defconfig
        
    - name: Download dependencies
      run: |
        cd openwrt
        make download -j$(nproc)
        
    - name: Build toolchain
      run: |
        cd openwrt
        make toolchain/install -j$(nproc)
        
    - name: Build package
      run: |
        cd openwrt
        make package/ipv6-relay-fix/compile -j$(nproc) V=s
        
    - name: Find built packages
      id: find-packages
      run: |
        cd openwrt
        PACKAGE_DIR=$(find bin -name "ipv6-relay-fix*.ipk" -type f | head -1 | xargs dirname)
        PACKAGE_FILE=$(find bin -name "ipv6-relay-fix*.ipk" -type f | head -1 | xargs basename)
        PACKAGE_ARCH=$(echo $PACKAGE_DIR | grep -o "packages-[^/]*" | cut -d'-' -f2)
        
        echo "package_dir=$PACKAGE_DIR" >> $GITHUB_OUTPUT
        echo "package_file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
        echo "package_arch=$PACKAGE_ARCH" >> $GITHUB_OUTPUT
        echo "package_path=$PACKAGE_DIR/$PACKAGE_FILE" >> $GITHUB_OUTPUT
        
        # List all built packages for debugging
        find bin -name "*.ipk" -type f | sort
        
    - name: Create release info
      run: |
        cd openwrt
        cat > package_info.txt << EOF
        Package: ipv6-relay-fix
        Version: $(grep PKG_VERSION package/network/ipv6/ipv6-relay-fix/Makefile | cut -d'=' -f2)
        Release: $(grep PKG_RELEASE package/network/ipv6/ipv6-relay-fix/Makefile | cut -d'=' -f2)
        Architecture: ${{ steps.find-packages.outputs.package_arch }}
        OpenWrt Version: ${{ env.OPENWRT_VERSION }}
        Built on: $(date)
        Commit: ${{ github.sha }}
        
        Installation:
        scp ${{ steps.find-packages.outputs.package_file }} root@router:/tmp/
        ssh root@router "opkg install /tmp/${{ steps.find-packages.outputs.package_file }}"
        
        Configuration:
        uci set ipv6-relay-fix.global.enabled='1'
        uci commit ipv6-relay-fix
        /etc/init.d/ipv6-relay-fix restart
        EOF
        
    - name: Upload IPK package
      uses: actions/upload-artifact@v3
      with:
        name: ipv6-relay-fix-${{ env.TARGET_ARCH }}-${{ env.OPENWRT_VERSION }}
        path: |
          openwrt/${{ steps.find-packages.outputs.package_path }}
          openwrt/package_info.txt
        retention-days: 30
        
    - name: Upload to release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          openwrt/${{ steps.find-packages.outputs.package_path }}
          openwrt/package_info.txt
        name: IPv6 Relay Fix ${{ github.ref_name }}
        body: |
          ## IPv6 Relay Fix Package
          
          **Target Architecture:** ${{ env.TARGET_ARCH }}  
          **OpenWrt Version:** ${{ env.OPENWRT_VERSION }}  
          **Package:** `${{ steps.find-packages.outputs.package_file }}`
          
          ### Installation
          ```
          # Upload to router
          scp ${{ steps.find-packages.outputs.package_file }} root@192.168.1.1:/tmp/
          
          # Install on router
          ssh root@192.168.1.1
          opkg install /tmp/${{ steps.find-packages.outputs.package_file }}
          
          # Configure and start
          uci set ipv6-relay-fix.global.enabled='1'
          uci commit ipv6-relay-fix
          /etc/init.d/ipv6-relay-fix restart
          ```
          
          ### Features
          - Automatic IPv6 relay mode configuration
          - Route table correction for downstream devices
          - Learning route conflict resolution
          - Hotplug-based route maintenance
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-matrix:
    if: github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        arch: [x86_64, aarch64_generic, arm_cortex-a9, mips_24kc]
        openwrt: [v23.05.2, v22.03.6]
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build for ${{ matrix.arch }} on ${{ matrix.openwrt }}
      uses: ./.github/workflows/build-ipv6-relay-fix.yml
      with:
        openwrt_version: ${{ matrix.openwrt }}
        target_arch: ${{ matrix.arch }}
